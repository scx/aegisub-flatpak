name: Aegisub
config-opts:
  - --disable-update-checker
  - --with-openal
  - --with-libpulse
  - --with-ffms2
  - --with-fftw3
  - --with-hunspell
  - --with-player-audio=PulseAudio
  - --with-boost-libdir=/app/lib
build-options:
  cppflags: -DU_USING_ICU_NAMESPACE=1
  env:
    agi_cv_with_openal: yes
sources:
  - type: git
    url: https://github.com/Aegisub/Aegisub
    commit: 2cb92a5f74634764ff5aac7e3ad0d647f98142af
    disable-shallow-clone: true
  # https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=873327#10
  # https://build.opensuse.org/package/view_file/multimedia:apps/aegisub/luabins.patch
  - type: patch
    path: aegisub-luabins.patch
  # Respect compiler flags
  # https://github.com/gentoo/gentoo/blob/be23ef21ed508c8e580f3ee8f302ce2abc5c3fbe/media-video/aegisub/files/3.2.2_p20160518/aegisub-3.2.2_p20160518-respect-compiler-flags.patch
  # https://web.archive.org/web/20161027172607/http://devel.aegisub.org/ticket/1899
  # https://web.archive.org/web/20161027171240/http://devel.aegisub.org/ticket/1900
  # https://github.com/Aegisub/Aegisub/pull/29
  - type: patch
    path: aegisub-respect-compiler-flags.patch
  # Fixes for Boost 1.69.0
  # https://github.com/Aegisub/Aegisub/issues/93
  # https://github.com/wangqr/Aegisub/commit/bb1f66a01f6e4661ab9c6610c5c2eee67bd0bd61
  - type: patch
    path: aegisub-boost-gil.patch
  # Fix version string
  # Use a more readable version string
  # e.g. 3.2.2+r8947 instead of 8947-master-2cb92a5
  # https://github.com/scx/Aegisub/commit/d24017d937a955be33e375a7bf1b82a953e4da6b
  - type: patch
    path: aegisub-version-git.patch
  - type: file
    path: org.aegisub.Aegisub.appdata.xml
  # Update AppData file
  # Change the OARS rating due to disabling the update checker
  - type: shell
    commands:
      - xmlstarlet ed --inplace -d "/component/content_rating/content_attribute[@id='social-info']" "org.aegisub.Aegisub.appdata.xml";
  - type: shell
    commands:
      - cp -p /usr/share/automake-*/config.{sub,guess} .;
      - autoreconf -vfi;
post-install:
  - |
    git_version_str="$( jq -r '.BUILD_GIT_VERSION_STRING' "build/git_version.json" )";
    git_version_date="$( jq -r '.BUILD_GIT_VERSION_DATE' "build/git_version.json" )";
    git_version_strold="$( xmlstarlet sel -t -v '/component/releases/release[1]/@version' -n "org.aegisub.Aegisub.appdata.xml" )";
    if [[ "${git_version_str}" != "" && "${git_version_date}" != ""  && "${git_version_str}" != "${git_version_strold}" ]]; then
      xmlstarlet ed --inplace -i '/component/releases/release[1]' -t elem -n 'release' -s '/component/releases/release[1]' -t attr -n 'version' -v "${git_version_str}" -s '/component/releases/release[1]' -t attr -n 'date' -v "${git_version_date}" "org.aegisub.Aegisub.appdata.xml";
    fi;
  - |
    icon_in="packages/desktop/scalable.svg";
    icon_out="aegisub.png";
    for s in {16,22,24,32,36,48,64,72,96,128,192,256,512}; do
      [[ ! -f "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/${icon_out}" ]] || continue;
      rsvg-convert "${icon_in}" -w "${s}" -h "${s}" -a -f png -o "${icon_out}";
      install -p -D -m 0644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
    done;
  - install -p -D -m 0644 "org.aegisub.Aegisub.appdata.xml" -t "${FLATPAK_DEST}/share/appdata/";
  - install -p -D -m 0644 "LICENCE" -t "${FLATPAK_DEST}/share/licenses/aegisub/";
